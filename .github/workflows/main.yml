name: Full CI/CD Pipeline (Code & Infrastructure)

on:
  push:
    branches: [ master ]

jobs:
  # 1. Existing job for code build and test
  build_and_test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    - name: Simulate Build Step
      run: echo "Code built successfully!"
    - name: Simulate Test Step
      run: |
        echo "Tests passed successfully!"
        exit 0 # Passes

  # --- New Job for IaC Deployment ---
  infrastructure_deployment:
    # Requires build_and_test to pass first
    needs: build_and_test 
    runs-on: ubuntu-latest
    
    # Needs Docker to be available for the terraform-docker provider
    services:
      docker:
        image: docker:dind
        options: --privileged
        
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.0.0 # Specify a compatible version
        
    - name: Terraform Init (IaC Setup)
      # Initializes the Terraform directory (within the subfolder)
      run: terraform init
      working-directory: ./terraform-docker-project
      
    - name: Terraform Plan (Review Change)
      # Checks syntax and generates the execution plan
      run: terraform plan
      working-directory: ./terraform-docker-project
      
    - name: Terraform Apply (Provision Infrastructure)
      # Executes the plan, creating the Docker container locally (on the runner)
      run: terraform apply -auto-approve
      working-directory: ./terraform-docker-project
